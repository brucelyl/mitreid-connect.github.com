<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MITREidDataService_1_3.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">OpenID Connect Server Webapp</a> &gt; <a href="../index.html" class="el_bundle">openid-connect-server</a> &gt; <a href="index.source.html" class="el_package">org.mitre.openid.connect.service.impl</a> &gt; <span class="el_source">MITREidDataService_1_3.java</span></div><h1>MITREidDataService_1_3.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright 2017 The MIT Internet Trust Consortium
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *******************************************************************************/
package org.mitre.openid.connect.service.impl;

import static org.mitre.util.JsonUtils.readMap;
import static org.mitre.util.JsonUtils.readSet;
import static org.mitre.util.JsonUtils.writeNullSafeArray;

import java.io.IOException;
import java.io.Serializable;
import java.text.ParseException;
import java.util.Collections;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Map.Entry;
import java.util.Set;

import org.mitre.oauth2.model.AuthenticationHolderEntity;
import org.mitre.oauth2.model.ClientDetailsEntity;
import org.mitre.oauth2.model.ClientDetailsEntity.AppType;
import org.mitre.oauth2.model.ClientDetailsEntity.AuthMethod;
import org.mitre.oauth2.model.ClientDetailsEntity.SubjectType;
import org.mitre.oauth2.model.OAuth2AccessTokenEntity;
import org.mitre.oauth2.model.OAuth2RefreshTokenEntity;
import org.mitre.oauth2.model.PKCEAlgorithm;
import org.mitre.oauth2.model.SavedUserAuthentication;
import org.mitre.oauth2.model.SystemScope;
import org.mitre.oauth2.repository.AuthenticationHolderRepository;
import org.mitre.oauth2.repository.OAuth2ClientRepository;
import org.mitre.oauth2.repository.OAuth2TokenRepository;
import org.mitre.oauth2.repository.SystemScopeRepository;
import org.mitre.openid.connect.model.ApprovedSite;
import org.mitre.openid.connect.model.BlacklistedSite;
import org.mitre.openid.connect.model.WhitelistedSite;
import org.mitre.openid.connect.repository.ApprovedSiteRepository;
import org.mitre.openid.connect.repository.BlacklistedSiteRepository;
import org.mitre.openid.connect.repository.WhitelistedSiteRepository;
import org.mitre.openid.connect.service.MITREidDataService;
import org.mitre.openid.connect.service.MITREidDataServiceExtension;
import org.mitre.openid.connect.service.MITREidDataServiceMaps;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.stereotype.Service;

import com.google.gson.stream.JsonReader;
import com.google.gson.stream.JsonToken;
import com.google.gson.stream.JsonWriter;
import com.nimbusds.jose.EncryptionMethod;
import com.nimbusds.jose.JWEAlgorithm;
import com.nimbusds.jose.JWSAlgorithm;
import com.nimbusds.jose.jwk.JWKSet;
import com.nimbusds.jwt.JWTParser;

/**
 *
 * Data service to import and export MITREid 1.3 configuration.
 *
 * @author jricher
 * @author arielak
 */
@Service
@SuppressWarnings(value = {&quot;unchecked&quot;})
<span class="nc" id="L80">public class MITREidDataService_1_3 extends MITREidDataServiceSupport implements MITREidDataService {</span>

	private static final String DEFAULT_SCOPE = &quot;defaultScope&quot;;
	private static final String RESTRICTED = &quot;restricted&quot;;
	private static final String ICON = &quot;icon&quot;;
	private static final String DYNAMICALLY_REGISTERED = &quot;dynamicallyRegistered&quot;;
	private static final String CLEAR_ACCESS_TOKENS_ON_REFRESH = &quot;clearAccessTokensOnRefresh&quot;;
	private static final String REUSE_REFRESH_TOKEN = &quot;reuseRefreshToken&quot;;
	private static final String ALLOW_INTROSPECTION = &quot;allowIntrospection&quot;;
	private static final String DESCRIPTION = &quot;description&quot;;
	private static final String REQUEST_URIS = &quot;requestUris&quot;;
	private static final String POST_LOGOUT_REDIRECT_URI = &quot;postLogoutRedirectUri&quot;;
	private static final String INTITATE_LOGIN_URI = &quot;intitateLoginUri&quot;;
	private static final String DEFAULT_ACR_VALUES = &quot;defaultACRValues&quot;;
	private static final String REQUIRE_AUTH_TIME = &quot;requireAuthTime&quot;;
	private static final String DEFAULT_MAX_AGE = &quot;defaultMaxAge&quot;;
	private static final String TOKEN_ENDPOINT_AUTH_SIGNING_ALG = &quot;tokenEndpointAuthSigningAlg&quot;;
	private static final String USER_INFO_ENCRYPTED_RESPONSE_ENC = &quot;userInfoEncryptedResponseEnc&quot;;
	private static final String USER_INFO_ENCRYPTED_RESPONSE_ALG = &quot;userInfoEncryptedResponseAlg&quot;;
	private static final String USER_INFO_SIGNED_RESPONSE_ALG = &quot;userInfoSignedResponseAlg&quot;;
	private static final String ID_TOKEN_ENCRYPTED_RESPONSE_ENC = &quot;idTokenEncryptedResponseEnc&quot;;
	private static final String ID_TOKEN_ENCRYPTED_RESPONSE_ALG = &quot;idTokenEncryptedResponseAlg&quot;;
	private static final String ID_TOKEN_SIGNED_RESPONSE_ALG = &quot;idTokenSignedResponseAlg&quot;;
	private static final String REQUEST_OBJECT_SIGNING_ALG = &quot;requestObjectSigningAlg&quot;;
	private static final String SUBJECT_TYPE = &quot;subjectType&quot;;
	private static final String SECTOR_IDENTIFIER_URI = &quot;sectorIdentifierUri&quot;;
	private static final String APPLICATION_TYPE = &quot;applicationType&quot;;
	private static final String JWKS = &quot;jwks&quot;;
	private static final String JWKS_URI = &quot;jwksUri&quot;;
	private static final String POLICY_URI = &quot;policyUri&quot;;
	private static final String GRANT_TYPES = &quot;grantTypes&quot;;
	private static final String TOKEN_ENDPOINT_AUTH_METHOD = &quot;tokenEndpointAuthMethod&quot;;
	private static final String TOS_URI = &quot;tosUri&quot;;
	private static final String CONTACTS = &quot;contacts&quot;;
	private static final String LOGO_URI = &quot;logoUri&quot;;
	private static final String REDIRECT_URIS = &quot;redirectUris&quot;;
	private static final String REFRESH_TOKEN_VALIDITY_SECONDS = &quot;refreshTokenValiditySeconds&quot;;
	private static final String ACCESS_TOKEN_VALIDITY_SECONDS = &quot;accessTokenValiditySeconds&quot;;
	private static final String ID_TOKEN_VALIDITY_SECONDS = &quot;idTokenValiditySeconds&quot;;
	private static final String DEVICE_CODE_VALIDITY_SECONDS = &quot;deviceCodeValiditySeconds&quot;;
	private static final String SECRET = &quot;secret&quot;;
	private static final String URI = &quot;uri&quot;;
	private static final String CREATOR_USER_ID = &quot;creatorUserId&quot;;
	private static final String APPROVED_ACCESS_TOKENS = &quot;approvedAccessTokens&quot;;
	private static final String ALLOWED_SCOPES = &quot;allowedScopes&quot;;
	private static final String USER_ID = &quot;userId&quot;;
	private static final String TIMEOUT_DATE = &quot;timeoutDate&quot;;
	private static final String CREATION_DATE = &quot;creationDate&quot;;
	private static final String ACCESS_DATE = &quot;accessDate&quot;;
	private static final String AUTHENTICATED = &quot;authenticated&quot;;
	private static final String SOURCE_CLASS = &quot;sourceClass&quot;;
	private static final String NAME = &quot;name&quot;;
	private static final String SAVED_USER_AUTHENTICATION = &quot;savedUserAuthentication&quot;;
	private static final String EXTENSIONS = &quot;extensions&quot;;
	private static final String RESPONSE_TYPES = &quot;responseTypes&quot;;
	private static final String REDIRECT_URI = &quot;redirectUri&quot;;
	private static final String APPROVED = &quot;approved&quot;;
	private static final String AUTHORITIES = &quot;authorities&quot;;
	private static final String RESOURCE_IDS = &quot;resourceIds&quot;;
	private static final String REQUEST_PARAMETERS = &quot;requestParameters&quot;;
	private static final String TYPE = &quot;type&quot;;
	private static final String SCOPE = &quot;scope&quot;;
	private static final String REFRESH_TOKEN_ID = &quot;refreshTokenId&quot;;
	private static final String VALUE = &quot;value&quot;;
	private static final String AUTHENTICATION_HOLDER_ID = &quot;authenticationHolderId&quot;;
	private static final String CLIENT_ID = &quot;clientId&quot;;
	private static final String EXPIRATION = &quot;expiration&quot;;
	private static final String CLAIMS_REDIRECT_URIS = &quot;claimsRedirectUris&quot;;
	private static final String ID = &quot;id&quot;;
	private static final String CODE_CHALLENGE_METHOD = &quot;codeChallengeMethod&quot;;
	private static final String SOFTWARE_STATEMENT = &quot;softwareStatement&quot;;
	private static final String SOFTWARE_VERSION = &quot;softwareVersion&quot;;
	private static final String SOFTWARE_ID = &quot;softwareId&quot;;

	/**
	 * Logger for this class
	 */
<span class="nc" id="L157">	private static final Logger logger = LoggerFactory.getLogger(MITREidDataService_1_3.class);</span>
	@Autowired
	private OAuth2ClientRepository clientRepository;
	@Autowired
	private ApprovedSiteRepository approvedSiteRepository;
	@Autowired
	private WhitelistedSiteRepository wlSiteRepository;
	@Autowired
	private BlacklistedSiteRepository blSiteRepository;
	@Autowired
	private AuthenticationHolderRepository authHolderRepository;
	@Autowired
	private OAuth2TokenRepository tokenRepository;
	@Autowired
	private SystemScopeRepository sysScopeRepository;
<span class="nc" id="L172">	@Autowired(required = false)</span>
<span class="nc" id="L173">	private List&lt;MITREidDataServiceExtension&gt; extensions = Collections.emptyList();</span>

	private static final String THIS_VERSION = MITREID_CONNECT_1_3;

<span class="nc" id="L177">	private MITREidDataServiceMaps maps = new MITREidDataServiceMaps();</span>

	@Override
	public boolean supportsVersion(String version) {
<span class="nc" id="L181">		return THIS_VERSION.equals(version);</span>
	}

	/* (non-Javadoc)
	 * @see org.mitre.openid.connect.service.MITREidDataService#export(com.google.gson.stream.JsonWriter)
	 */
	@Override
	public void exportData(JsonWriter writer) throws IOException {

		// version tag at the root
<span class="nc" id="L191">		writer.name(THIS_VERSION);</span>

<span class="nc" id="L193">		writer.beginObject();</span>

		// clients list
<span class="nc" id="L196">		writer.name(CLIENTS);</span>
<span class="nc" id="L197">		writer.beginArray();</span>
<span class="nc" id="L198">		writeClients(writer);</span>
<span class="nc" id="L199">		writer.endArray();</span>

<span class="nc" id="L201">		writer.name(GRANTS);</span>
<span class="nc" id="L202">		writer.beginArray();</span>
<span class="nc" id="L203">		writeGrants(writer);</span>
<span class="nc" id="L204">		writer.endArray();</span>

<span class="nc" id="L206">		writer.name(WHITELISTEDSITES);</span>
<span class="nc" id="L207">		writer.beginArray();</span>
<span class="nc" id="L208">		writeWhitelistedSites(writer);</span>
<span class="nc" id="L209">		writer.endArray();</span>

<span class="nc" id="L211">		writer.name(BLACKLISTEDSITES);</span>
<span class="nc" id="L212">		writer.beginArray();</span>
<span class="nc" id="L213">		writeBlacklistedSites(writer);</span>
<span class="nc" id="L214">		writer.endArray();</span>

<span class="nc" id="L216">		writer.name(AUTHENTICATIONHOLDERS);</span>
<span class="nc" id="L217">		writer.beginArray();</span>
<span class="nc" id="L218">		writeAuthenticationHolders(writer);</span>
<span class="nc" id="L219">		writer.endArray();</span>

<span class="nc" id="L221">		writer.name(ACCESSTOKENS);</span>
<span class="nc" id="L222">		writer.beginArray();</span>
<span class="nc" id="L223">		writeAccessTokens(writer);</span>
<span class="nc" id="L224">		writer.endArray();</span>

<span class="nc" id="L226">		writer.name(REFRESHTOKENS);</span>
<span class="nc" id="L227">		writer.beginArray();</span>
<span class="nc" id="L228">		writeRefreshTokens(writer);</span>
<span class="nc" id="L229">		writer.endArray();</span>

<span class="nc" id="L231">		writer.name(SYSTEMSCOPES);</span>
<span class="nc" id="L232">		writer.beginArray();</span>
<span class="nc" id="L233">		writeSystemScopes(writer);</span>
<span class="nc" id="L234">		writer.endArray();</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">		for (MITREidDataServiceExtension extension : extensions) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (extension.supportsVersion(THIS_VERSION)) {</span>
<span class="nc" id="L238">				extension.exportExtensionData(writer);</span>
<span class="nc" id="L239">				break;</span>
			}
<span class="nc" id="L241">		}</span>

<span class="nc" id="L243">		writer.endObject(); // end mitreid-connect-1.3</span>
<span class="nc" id="L244">	}</span>

	/**
	 * @param writer
	 */
	private void writeRefreshTokens(JsonWriter writer) throws IOException {
<span class="nc bnc" id="L250" title="All 2 branches missed.">		for (OAuth2RefreshTokenEntity token : tokenRepository.getAllRefreshTokens()) {</span>
<span class="nc" id="L251">			writer.beginObject();</span>
<span class="nc" id="L252">			writer.name(ID).value(token.getId());</span>
<span class="nc" id="L253">			writer.name(EXPIRATION).value(toUTCString(token.getExpiration()));</span>
<span class="nc" id="L254">			writer.name(CLIENT_ID)</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">			.value((token.getClient() != null) ? token.getClient().getClientId() : null);</span>
<span class="nc" id="L256">			writer.name(AUTHENTICATION_HOLDER_ID)</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">			.value((token.getAuthenticationHolder() != null) ? token.getAuthenticationHolder().getId() : null);</span>
<span class="nc" id="L258">			writer.name(VALUE).value(token.getValue());</span>
<span class="nc" id="L259">			writer.endObject();</span>
<span class="nc" id="L260">			logger.debug(&quot;Wrote refresh token {}&quot;, token.getId());</span>
<span class="nc" id="L261">		}</span>
<span class="nc" id="L262">		logger.info(&quot;Done writing refresh tokens&quot;);</span>
<span class="nc" id="L263">	}</span>

	/**
	 * @param writer
	 */
	private void writeAccessTokens(JsonWriter writer) throws IOException {
<span class="nc bnc" id="L269" title="All 2 branches missed.">		for (OAuth2AccessTokenEntity token : tokenRepository.getAllAccessTokens()) {</span>
<span class="nc" id="L270">			writer.beginObject();</span>
<span class="nc" id="L271">			writer.name(ID).value(token.getId());</span>
<span class="nc" id="L272">			writer.name(EXPIRATION).value(toUTCString(token.getExpiration()));</span>
<span class="nc" id="L273">			writer.name(CLIENT_ID)</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			.value((token.getClient() != null) ? token.getClient().getClientId() : null);</span>
<span class="nc" id="L275">			writer.name(AUTHENTICATION_HOLDER_ID)</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">			.value((token.getAuthenticationHolder() != null) ? token.getAuthenticationHolder().getId() : null);</span>
<span class="nc" id="L277">			writer.name(REFRESH_TOKEN_ID)</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			.value((token.getRefreshToken() != null) ? token.getRefreshToken().getId() : null);</span>
<span class="nc" id="L279">			writer.name(SCOPE);</span>
<span class="nc" id="L280">			writer.beginArray();</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">			for (String s : token.getScope()) {</span>
<span class="nc" id="L282">				writer.value(s);</span>
<span class="nc" id="L283">			}</span>
<span class="nc" id="L284">			writer.endArray();</span>
<span class="nc" id="L285">			writer.name(TYPE).value(token.getTokenType());</span>
<span class="nc" id="L286">			writer.name(VALUE).value(token.getValue());</span>
<span class="nc" id="L287">			writer.endObject();</span>
<span class="nc" id="L288">			logger.debug(&quot;Wrote access token {}&quot;, token.getId());</span>
<span class="nc" id="L289">		}</span>
<span class="nc" id="L290">		logger.info(&quot;Done writing access tokens&quot;);</span>
<span class="nc" id="L291">	}</span>

	/**
	 * @param writer
	 */
	private void writeAuthenticationHolders(JsonWriter writer) throws IOException {
<span class="nc bnc" id="L297" title="All 2 branches missed.">		for (AuthenticationHolderEntity holder : authHolderRepository.getAll()) {</span>
<span class="nc" id="L298">			writer.beginObject();</span>
<span class="nc" id="L299">			writer.name(ID).value(holder.getId());</span>

<span class="nc" id="L301">			writer.name(REQUEST_PARAMETERS);</span>
<span class="nc" id="L302">			writer.beginObject();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">			for (Entry&lt;String, String&gt; entry : holder.getRequestParameters().entrySet()) {</span>
<span class="nc" id="L304">				writer.name(entry.getKey()).value(entry.getValue());</span>
<span class="nc" id="L305">			}</span>
<span class="nc" id="L306">			writer.endObject();</span>
<span class="nc" id="L307">			writer.name(CLIENT_ID).value(holder.getClientId());</span>
<span class="nc" id="L308">			Set&lt;String&gt; scope = holder.getScope();</span>
<span class="nc" id="L309">			writer.name(SCOPE);</span>
<span class="nc" id="L310">			writer.beginArray();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">			for (String s : scope) {</span>
<span class="nc" id="L312">				writer.value(s);</span>
<span class="nc" id="L313">			}</span>
<span class="nc" id="L314">			writer.endArray();</span>
<span class="nc" id="L315">			writer.name(RESOURCE_IDS);</span>
<span class="nc" id="L316">			writer.beginArray();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">			if (holder.getResourceIds() != null) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">				for (String s : holder.getResourceIds()) {</span>
<span class="nc" id="L319">					writer.value(s);</span>
<span class="nc" id="L320">				}</span>
			}
<span class="nc" id="L322">			writer.endArray();</span>
<span class="nc" id="L323">			writer.name(AUTHORITIES);</span>
<span class="nc" id="L324">			writer.beginArray();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">			for (GrantedAuthority authority : holder.getAuthorities()) {</span>
<span class="nc" id="L326">				writer.value(authority.getAuthority());</span>
<span class="nc" id="L327">			}</span>
<span class="nc" id="L328">			writer.endArray();</span>
<span class="nc" id="L329">			writer.name(APPROVED).value(holder.isApproved());</span>
<span class="nc" id="L330">			writer.name(REDIRECT_URI).value(holder.getRedirectUri());</span>
<span class="nc" id="L331">			writer.name(RESPONSE_TYPES);</span>
<span class="nc" id="L332">			writer.beginArray();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">			for (String s : holder.getResponseTypes()) {</span>
<span class="nc" id="L334">				writer.value(s);</span>
<span class="nc" id="L335">			}</span>
<span class="nc" id="L336">			writer.endArray();</span>
<span class="nc" id="L337">			writer.name(EXTENSIONS);</span>
<span class="nc" id="L338">			writer.beginObject();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">			for (Entry&lt;String, Serializable&gt; entry : holder.getExtensions().entrySet()) {</span>
				// while the extension map itself is Serializable, we enforce storage of Strings
<span class="nc bnc" id="L341" title="All 2 branches missed.">				if (entry.getValue() instanceof String) {</span>
<span class="nc" id="L342">					writer.name(entry.getKey()).value((String) entry.getValue());</span>
				} else {
<span class="nc" id="L344">					logger.warn(&quot;Skipping non-string extension: &quot; + entry);</span>
				}
<span class="nc" id="L346">			}</span>
<span class="nc" id="L347">			writer.endObject();</span>

<span class="nc" id="L349">			writer.name(SAVED_USER_AUTHENTICATION);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">			if (holder.getUserAuth() != null) {</span>
<span class="nc" id="L351">				writer.beginObject();</span>
<span class="nc" id="L352">				writer.name(NAME).value(holder.getUserAuth().getName());</span>
<span class="nc" id="L353">				writer.name(SOURCE_CLASS).value(holder.getUserAuth().getSourceClass());</span>
<span class="nc" id="L354">				writer.name(AUTHENTICATED).value(holder.getUserAuth().isAuthenticated());</span>
<span class="nc" id="L355">				writer.name(AUTHORITIES);</span>
<span class="nc" id="L356">				writer.beginArray();</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">				for (GrantedAuthority authority : holder.getUserAuth().getAuthorities()) {</span>
<span class="nc" id="L358">					writer.value(authority.getAuthority());</span>
<span class="nc" id="L359">				}</span>
<span class="nc" id="L360">				writer.endArray();</span>

<span class="nc" id="L362">				writer.endObject();</span>
			} else {
<span class="nc" id="L364">				writer.nullValue();</span>
			}


<span class="nc" id="L368">			writer.endObject();</span>
<span class="nc" id="L369">			logger.debug(&quot;Wrote authentication holder {}&quot;, holder.getId());</span>
<span class="nc" id="L370">		}</span>
<span class="nc" id="L371">		logger.info(&quot;Done writing authentication holders&quot;);</span>
<span class="nc" id="L372">	}</span>

	/**
	 * @param writer
	 */
	private void writeGrants(JsonWriter writer) throws IOException {
<span class="nc bnc" id="L378" title="All 2 branches missed.">		for (ApprovedSite site : approvedSiteRepository.getAll()) {</span>
<span class="nc" id="L379">			writer.beginObject();</span>
<span class="nc" id="L380">			writer.name(ID).value(site.getId());</span>
<span class="nc" id="L381">			writer.name(ACCESS_DATE).value(toUTCString(site.getAccessDate()));</span>
<span class="nc" id="L382">			writer.name(CLIENT_ID).value(site.getClientId());</span>
<span class="nc" id="L383">			writer.name(CREATION_DATE).value(toUTCString(site.getCreationDate()));</span>
<span class="nc" id="L384">			writer.name(TIMEOUT_DATE).value(toUTCString(site.getTimeoutDate()));</span>
<span class="nc" id="L385">			writer.name(USER_ID).value(site.getUserId());</span>
<span class="nc" id="L386">			writer.name(ALLOWED_SCOPES);</span>
<span class="nc" id="L387">			writeNullSafeArray(writer, site.getAllowedScopes());</span>
<span class="nc" id="L388">			List&lt;OAuth2AccessTokenEntity&gt; tokens = tokenRepository.getAccessTokensForApprovedSite(site);</span>
<span class="nc" id="L389">			writer.name(APPROVED_ACCESS_TOKENS);</span>
<span class="nc" id="L390">			writer.beginArray();</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">			for (OAuth2AccessTokenEntity token : tokens) {</span>
<span class="nc" id="L392">				writer.value(token.getId());</span>
<span class="nc" id="L393">			}</span>
<span class="nc" id="L394">			writer.endArray();</span>
<span class="nc" id="L395">			writer.endObject();</span>
<span class="nc" id="L396">			logger.debug(&quot;Wrote grant {}&quot;, site.getId());</span>
<span class="nc" id="L397">		}</span>
<span class="nc" id="L398">		logger.info(&quot;Done writing grants&quot;);</span>
<span class="nc" id="L399">	}</span>

	/**
	 * @param writer
	 */
	private void writeWhitelistedSites(JsonWriter writer) throws IOException {
<span class="nc bnc" id="L405" title="All 2 branches missed.">		for (WhitelistedSite wlSite : wlSiteRepository.getAll()) {</span>
<span class="nc" id="L406">			writer.beginObject();</span>
<span class="nc" id="L407">			writer.name(ID).value(wlSite.getId());</span>
<span class="nc" id="L408">			writer.name(CLIENT_ID).value(wlSite.getClientId());</span>
<span class="nc" id="L409">			writer.name(CREATOR_USER_ID).value(wlSite.getCreatorUserId());</span>
<span class="nc" id="L410">			writer.name(ALLOWED_SCOPES);</span>
<span class="nc" id="L411">			writeNullSafeArray(writer, wlSite.getAllowedScopes());</span>
<span class="nc" id="L412">			writer.endObject();</span>
<span class="nc" id="L413">			logger.debug(&quot;Wrote whitelisted site {}&quot;, wlSite.getId());</span>
<span class="nc" id="L414">		}</span>
<span class="nc" id="L415">		logger.info(&quot;Done writing whitelisted sites&quot;);</span>
<span class="nc" id="L416">	}</span>

	/**
	 * @param writer
	 */
	private void writeBlacklistedSites(JsonWriter writer) throws IOException {
<span class="nc bnc" id="L422" title="All 2 branches missed.">		for (BlacklistedSite blSite : blSiteRepository.getAll()) {</span>
<span class="nc" id="L423">			writer.beginObject();</span>
<span class="nc" id="L424">			writer.name(ID).value(blSite.getId());</span>
<span class="nc" id="L425">			writer.name(URI).value(blSite.getUri());</span>
<span class="nc" id="L426">			writer.endObject();</span>
<span class="nc" id="L427">			logger.debug(&quot;Wrote blacklisted site {}&quot;, blSite.getId());</span>
<span class="nc" id="L428">		}</span>
<span class="nc" id="L429">		logger.info(&quot;Done writing blacklisted sites&quot;);</span>
<span class="nc" id="L430">	}</span>

	/**
	 * @param writer
	 */
	private void writeClients(JsonWriter writer) {
<span class="nc bnc" id="L436" title="All 2 branches missed.">		for (ClientDetailsEntity client : clientRepository.getAllClients()) {</span>
			try {
<span class="nc" id="L438">				writer.beginObject();</span>
<span class="nc" id="L439">				writer.name(CLIENT_ID).value(client.getClientId());</span>
<span class="nc" id="L440">				writer.name(RESOURCE_IDS);</span>
<span class="nc" id="L441">				writeNullSafeArray(writer, client.getResourceIds());</span>

<span class="nc" id="L443">				writer.name(SECRET).value(client.getClientSecret());</span>

<span class="nc" id="L445">				writer.name(SCOPE);</span>
<span class="nc" id="L446">				writeNullSafeArray(writer, client.getScope());</span>

<span class="nc" id="L448">				writer.name(AUTHORITIES);</span>
<span class="nc" id="L449">				writer.beginArray();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">				for (GrantedAuthority authority : client.getAuthorities()) {</span>
<span class="nc" id="L451">					writer.value(authority.getAuthority());</span>
<span class="nc" id="L452">				}</span>
<span class="nc" id="L453">				writer.endArray();</span>
<span class="nc" id="L454">				writer.name(ACCESS_TOKEN_VALIDITY_SECONDS).value(client.getAccessTokenValiditySeconds());</span>
<span class="nc" id="L455">				writer.name(REFRESH_TOKEN_VALIDITY_SECONDS).value(client.getRefreshTokenValiditySeconds());</span>
<span class="nc" id="L456">				writer.name(ID_TOKEN_VALIDITY_SECONDS).value(client.getIdTokenValiditySeconds());</span>
<span class="nc" id="L457">				writer.name(DEVICE_CODE_VALIDITY_SECONDS).value(client.getDeviceCodeValiditySeconds());</span>
<span class="nc" id="L458">				writer.name(REDIRECT_URIS);</span>
<span class="nc" id="L459">				writeNullSafeArray(writer, client.getRedirectUris());</span>
<span class="nc" id="L460">				writer.name(CLAIMS_REDIRECT_URIS);</span>
<span class="nc" id="L461">				writeNullSafeArray(writer, client.getClaimsRedirectUris());</span>
<span class="nc" id="L462">				writer.name(NAME).value(client.getClientName());</span>
<span class="nc" id="L463">				writer.name(URI).value(client.getClientUri());</span>
<span class="nc" id="L464">				writer.name(LOGO_URI).value(client.getLogoUri());</span>
<span class="nc" id="L465">				writer.name(CONTACTS);</span>
<span class="nc" id="L466">				writeNullSafeArray(writer, client.getContacts());</span>
<span class="nc" id="L467">				writer.name(TOS_URI).value(client.getTosUri());</span>
<span class="nc" id="L468">				writer.name(TOKEN_ENDPOINT_AUTH_METHOD)</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">				.value((client.getTokenEndpointAuthMethod() != null) ? client.getTokenEndpointAuthMethod().getValue() : null);</span>
<span class="nc" id="L470">				writer.name(GRANT_TYPES);</span>
<span class="nc" id="L471">				writer.beginArray();</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">				for (String s : client.getGrantTypes()) {</span>
<span class="nc" id="L473">					writer.value(s);</span>
<span class="nc" id="L474">				}</span>
<span class="nc" id="L475">				writer.endArray();</span>
<span class="nc" id="L476">				writer.name(RESPONSE_TYPES);</span>
<span class="nc" id="L477">				writer.beginArray();</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">				for (String s : client.getResponseTypes()) {</span>
<span class="nc" id="L479">					writer.value(s);</span>
<span class="nc" id="L480">				}</span>
<span class="nc" id="L481">				writer.endArray();</span>
<span class="nc" id="L482">				writer.name(POLICY_URI).value(client.getPolicyUri());</span>
<span class="nc" id="L483">				writer.name(JWKS_URI).value(client.getJwksUri());</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">				writer.name(JWKS).value((client.getJwks() != null) ? client.getJwks().toString() : null);</span>
<span class="nc" id="L485">				writer.name(APPLICATION_TYPE)</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">				.value((client.getApplicationType() != null) ? client.getApplicationType().getValue() : null);</span>
<span class="nc" id="L487">				writer.name(SECTOR_IDENTIFIER_URI).value(client.getSectorIdentifierUri());</span>
<span class="nc" id="L488">				writer.name(SUBJECT_TYPE)</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">				.value((client.getSubjectType() != null) ? client.getSubjectType().getValue() : null);</span>
<span class="nc" id="L490">				writer.name(REQUEST_OBJECT_SIGNING_ALG)</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">				.value((client.getRequestObjectSigningAlg() != null) ? client.getRequestObjectSigningAlg().getName() : null);</span>
<span class="nc" id="L492">				writer.name(ID_TOKEN_SIGNED_RESPONSE_ALG)</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">				.value((client.getIdTokenSignedResponseAlg() != null) ? client.getIdTokenSignedResponseAlg().getName() : null);</span>
<span class="nc" id="L494">				writer.name(ID_TOKEN_ENCRYPTED_RESPONSE_ALG)</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">				.value((client.getIdTokenEncryptedResponseAlg() != null) ? client.getIdTokenEncryptedResponseAlg().getName() : null);</span>
<span class="nc" id="L496">				writer.name(ID_TOKEN_ENCRYPTED_RESPONSE_ENC)</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">				.value((client.getIdTokenEncryptedResponseEnc() != null) ? client.getIdTokenEncryptedResponseEnc().getName() : null);</span>
<span class="nc" id="L498">				writer.name(USER_INFO_SIGNED_RESPONSE_ALG)</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">				.value((client.getUserInfoSignedResponseAlg() != null) ? client.getUserInfoSignedResponseAlg().getName() : null);</span>
<span class="nc" id="L500">				writer.name(USER_INFO_ENCRYPTED_RESPONSE_ALG)</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">				.value((client.getUserInfoEncryptedResponseAlg() != null) ? client.getUserInfoEncryptedResponseAlg().getName() : null);</span>
<span class="nc" id="L502">				writer.name(USER_INFO_ENCRYPTED_RESPONSE_ENC)</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">				.value((client.getUserInfoEncryptedResponseEnc() != null) ? client.getUserInfoEncryptedResponseEnc().getName() : null);</span>
<span class="nc" id="L504">				writer.name(TOKEN_ENDPOINT_AUTH_SIGNING_ALG)</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">				.value((client.getTokenEndpointAuthSigningAlg() != null) ? client.getTokenEndpointAuthSigningAlg().getName() : null);</span>
<span class="nc" id="L506">				writer.name(DEFAULT_MAX_AGE).value(client.getDefaultMaxAge());</span>
<span class="nc" id="L507">				Boolean requireAuthTime = null;</span>
				try {
<span class="nc" id="L509">					requireAuthTime = client.getRequireAuthTime();</span>
<span class="nc" id="L510">				} catch (NullPointerException e) {</span>
<span class="nc" id="L511">				}</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">				if (requireAuthTime != null) {</span>
<span class="nc" id="L513">					writer.name(REQUIRE_AUTH_TIME).value(requireAuthTime);</span>
				}
<span class="nc" id="L515">				writer.name(DEFAULT_ACR_VALUES);</span>
<span class="nc" id="L516">				writeNullSafeArray(writer, client.getDefaultACRvalues());</span>
<span class="nc" id="L517">				writer.name(INTITATE_LOGIN_URI).value(client.getInitiateLoginUri());</span>
<span class="nc" id="L518">				writer.name(POST_LOGOUT_REDIRECT_URI);</span>
<span class="nc" id="L519">				writeNullSafeArray(writer, client.getPostLogoutRedirectUris());</span>
<span class="nc" id="L520">				writer.name(REQUEST_URIS);</span>
<span class="nc" id="L521">				writeNullSafeArray(writer, client.getRequestUris());</span>
<span class="nc" id="L522">				writer.name(DESCRIPTION).value(client.getClientDescription());</span>
<span class="nc" id="L523">				writer.name(ALLOW_INTROSPECTION).value(client.isAllowIntrospection());</span>
<span class="nc" id="L524">				writer.name(REUSE_REFRESH_TOKEN).value(client.isReuseRefreshToken());</span>
<span class="nc" id="L525">				writer.name(CLEAR_ACCESS_TOKENS_ON_REFRESH).value(client.isClearAccessTokensOnRefresh());</span>
<span class="nc" id="L526">				writer.name(DYNAMICALLY_REGISTERED).value(client.isDynamicallyRegistered());</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">				writer.name(CODE_CHALLENGE_METHOD).value(client.getCodeChallengeMethod() != null ? client.getCodeChallengeMethod().getName() : null);</span>
<span class="nc" id="L528">				writer.name(SOFTWARE_ID).value(client.getSoftwareId());</span>
<span class="nc" id="L529">				writer.name(SOFTWARE_VERSION).value(client.getSoftwareVersion());</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">				writer.name(SOFTWARE_STATEMENT).value(client.getSoftwareStatement() != null ? client.getSoftwareStatement().serialize() : null);</span>
<span class="nc" id="L531">				writer.name(CREATION_DATE).value(toUTCString(client.getCreatedAt()));</span>
<span class="nc" id="L532">				writer.endObject();</span>
<span class="nc" id="L533">				logger.debug(&quot;Wrote client {}&quot;, client.getId());</span>
<span class="nc" id="L534">			} catch (IOException ex) {</span>
<span class="nc" id="L535">				logger.error(&quot;Unable to write client {}&quot;, client.getId(), ex);</span>
<span class="nc" id="L536">			}</span>
<span class="nc" id="L537">		}</span>
<span class="nc" id="L538">		logger.info(&quot;Done writing clients&quot;);</span>
<span class="nc" id="L539">	}</span>

	/**
	 * @param writer
	 */
	private void writeSystemScopes(JsonWriter writer) {
<span class="nc bnc" id="L545" title="All 2 branches missed.">		for (SystemScope sysScope : sysScopeRepository.getAll()) {</span>
			try {
<span class="nc" id="L547">				writer.beginObject();</span>
<span class="nc" id="L548">				writer.name(ID).value(sysScope.getId());</span>
<span class="nc" id="L549">				writer.name(DESCRIPTION).value(sysScope.getDescription());</span>
<span class="nc" id="L550">				writer.name(ICON).value(sysScope.getIcon());</span>
<span class="nc" id="L551">				writer.name(VALUE).value(sysScope.getValue());</span>
<span class="nc" id="L552">				writer.name(RESTRICTED).value(sysScope.isRestricted());</span>
<span class="nc" id="L553">				writer.name(DEFAULT_SCOPE).value(sysScope.isDefaultScope());</span>
<span class="nc" id="L554">				writer.endObject();</span>
<span class="nc" id="L555">				logger.debug(&quot;Wrote system scope {}&quot;, sysScope.getId());</span>
<span class="nc" id="L556">			} catch (IOException ex) {</span>
<span class="nc" id="L557">				logger.error(&quot;Unable to write system scope {}&quot;, sysScope.getId(), ex);</span>
<span class="nc" id="L558">			}</span>
<span class="nc" id="L559">		}</span>
<span class="nc" id="L560">		logger.info(&quot;Done writing system scopes&quot;);</span>
<span class="nc" id="L561">	}</span>

	/* (non-Javadoc)
	 * @see org.mitre.openid.connect.service.MITREidDataService#importData(com.google.gson.stream.JsonReader)
	 */
	@Override
	public void importData(JsonReader reader) throws IOException {

<span class="nc" id="L569">		logger.info(&quot;Reading configuration for 1.3&quot;);</span>

		// this *HAS* to start as an object
<span class="nc" id="L572">		reader.beginObject();</span>

<span class="nc bnc" id="L574" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L575">			JsonToken tok = reader.peek();</span>
<span class="nc bnc" id="L576" title="All 3 branches missed.">			switch (tok) {</span>
				case NAME:
<span class="nc" id="L578">					String name = reader.nextName();</span>
					// find out which member it is
<span class="nc bnc" id="L580" title="All 2 branches missed.">					if (name.equals(CLIENTS)) {</span>
<span class="nc" id="L581">						readClients(reader);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">					} else if (name.equals(GRANTS)) {</span>
<span class="nc" id="L583">						readGrants(reader);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">					} else if (name.equals(WHITELISTEDSITES)) {</span>
<span class="nc" id="L585">						readWhitelistedSites(reader);</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">					} else if (name.equals(BLACKLISTEDSITES)) {</span>
<span class="nc" id="L587">						readBlacklistedSites(reader);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">					} else if (name.equals(AUTHENTICATIONHOLDERS)) {</span>
<span class="nc" id="L589">						readAuthenticationHolders(reader);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">					} else if (name.equals(ACCESSTOKENS)) {</span>
<span class="nc" id="L591">						readAccessTokens(reader);</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">					} else if (name.equals(REFRESHTOKENS)) {</span>
<span class="nc" id="L593">						readRefreshTokens(reader);</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">					} else if (name.equals(SYSTEMSCOPES)) {</span>
<span class="nc" id="L595">						readSystemScopes(reader);</span>
					} else {
<span class="nc" id="L597">						boolean processed = false;</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">						for (MITREidDataServiceExtension extension : extensions) {</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">							if (extension.supportsVersion(THIS_VERSION)) {</span>
<span class="nc" id="L600">								processed = extension.importExtensionData(name, reader);</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">								if (processed) {</span>
									// if the extension processed data, break out of this inner loop
									// (only the first extension to claim an extension point gets it)
<span class="nc" id="L604">									break;</span>
								}
							}
<span class="nc" id="L607">						}</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">						if (!processed) {</span>
							// unknown token, skip it
<span class="nc" id="L610">							reader.skipValue();</span>
						}
					}
<span class="nc" id="L613">					break;</span>
				case END_OBJECT:
					// the object ended, we're done here
<span class="nc" id="L616">					reader.endObject();</span>
<span class="nc" id="L617">					continue;</span>
				default:
<span class="nc" id="L619">					logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L620">					reader.skipValue();</span>
<span class="nc" id="L621">					continue;</span>
			}
<span class="nc" id="L623">		}</span>
<span class="nc" id="L624">		fixObjectReferences();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">		for (MITREidDataServiceExtension extension : extensions) {</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">			if (extension.supportsVersion(THIS_VERSION)) {</span>
<span class="nc" id="L627">				extension.fixExtensionObjectReferences(maps);</span>
<span class="nc" id="L628">				break;</span>
			}
<span class="nc" id="L630">		}</span>
<span class="nc" id="L631">		maps.clearAll();</span>
<span class="nc" id="L632">	}</span>

	/**
	 * @param reader
	 * @throws IOException
	 */
	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readRefreshTokens(JsonReader reader) throws IOException {
<span class="nc" id="L643">		reader.beginArray();</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L645">			OAuth2RefreshTokenEntity token = new OAuth2RefreshTokenEntity();</span>
<span class="nc" id="L646">			reader.beginObject();</span>
<span class="nc" id="L647">			Long currentId = null;</span>
<span class="nc" id="L648">			String clientId = null;</span>
<span class="nc" id="L649">			Long authHolderId = null;</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L651" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L653">						continue;</span>
					case NAME:
<span class="nc" id="L655">						String name = reader.nextName();</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">						if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L657">							reader.skipValue();</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">						} else if (name.equals(ID)) {</span>
<span class="nc" id="L659">							currentId = reader.nextLong();</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">						} else if (name.equals(EXPIRATION)) {</span>
<span class="nc" id="L661">							Date date = utcToDate(reader.nextString());</span>
<span class="nc" id="L662">							token.setExpiration(date);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">						} else if (name.equals(VALUE)) {</span>
<span class="nc" id="L664">							String value = reader.nextString();</span>
							try {
<span class="nc" id="L666">								token.setJwt(JWTParser.parse(value));</span>
<span class="nc" id="L667">							} catch (ParseException ex) {</span>
<span class="nc" id="L668">								logger.error(&quot;Unable to set refresh token value to {}&quot;, value, ex);</span>
<span class="nc" id="L669">							}</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">						} else if (name.equals(CLIENT_ID)) {</span>
<span class="nc" id="L671">							clientId = reader.nextString();</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">						} else if (name.equals(AUTHENTICATION_HOLDER_ID)) {</span>
<span class="nc" id="L673">							authHolderId = reader.nextLong();</span>
						} else {
<span class="nc" id="L675">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L676">							reader.skipValue();</span>
						}
<span class="nc" id="L678">						break;</span>
					default:
<span class="nc" id="L680">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L681">						reader.skipValue();</span>
<span class="nc" id="L682">						continue;</span>
				}
			}
<span class="nc" id="L685">			reader.endObject();</span>
<span class="nc" id="L686">			Long newId = tokenRepository.saveRefreshToken(token).getId();</span>
<span class="nc" id="L687">			maps.getRefreshTokenToClientRefs().put(currentId, clientId);</span>
<span class="nc" id="L688">			maps.getRefreshTokenToAuthHolderRefs().put(currentId, authHolderId);</span>
<span class="nc" id="L689">			maps.getRefreshTokenOldToNewIdMap().put(currentId, newId);</span>
<span class="nc" id="L690">			logger.debug(&quot;Read refresh token {}&quot;, currentId);</span>
<span class="nc" id="L691">		}</span>
<span class="nc" id="L692">		reader.endArray();</span>
<span class="nc" id="L693">		logger.info(&quot;Done reading refresh tokens&quot;);</span>
<span class="nc" id="L694">	}</span>
	/**
	 * @param reader
	 * @throws IOException
	 */
	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readAccessTokens(JsonReader reader) throws IOException {
<span class="nc" id="L704">		reader.beginArray();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L706">			OAuth2AccessTokenEntity token = new OAuth2AccessTokenEntity();</span>
<span class="nc" id="L707">			reader.beginObject();</span>
<span class="nc" id="L708">			Long currentId = null;</span>
<span class="nc" id="L709">			String clientId = null;</span>
<span class="nc" id="L710">			Long authHolderId = null;</span>
<span class="nc" id="L711">			Long refreshTokenId = null;</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L713" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L715">						continue;</span>
					case NAME:
<span class="nc" id="L717">						String name = reader.nextName();</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">						if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L719">							reader.skipValue();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">						} else if (name.equals(ID)) {</span>
<span class="nc" id="L721">							currentId = reader.nextLong();</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">						} else if (name.equals(EXPIRATION)) {</span>
<span class="nc" id="L723">							Date date = utcToDate(reader.nextString());</span>
<span class="nc" id="L724">							token.setExpiration(date);</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">						} else if (name.equals(VALUE)) {</span>
<span class="nc" id="L726">							String value = reader.nextString();</span>
							try {
								// all tokens are JWTs
<span class="nc" id="L729">								token.setJwt(JWTParser.parse(value));</span>
<span class="nc" id="L730">							} catch (ParseException ex) {</span>
<span class="nc" id="L731">								logger.error(&quot;Unable to set refresh token value to {}&quot;, value, ex);</span>
<span class="nc" id="L732">							}</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">						} else if (name.equals(CLIENT_ID)) {</span>
<span class="nc" id="L734">							clientId = reader.nextString();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">						} else if (name.equals(AUTHENTICATION_HOLDER_ID)) {</span>
<span class="nc" id="L736">							authHolderId = reader.nextLong();</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">						} else if (name.equals(REFRESH_TOKEN_ID)) {</span>
<span class="nc" id="L738">							refreshTokenId = reader.nextLong();</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">						} else if (name.equals(SCOPE)) {</span>
<span class="nc" id="L740">							Set&lt;String&gt; scope = readSet(reader);</span>
<span class="nc" id="L741">							token.setScope(scope);</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">						} else if (name.equals(TYPE)) {</span>
<span class="nc" id="L743">							token.setTokenType(reader.nextString());</span>
						} else {
<span class="nc" id="L745">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L746">							reader.skipValue();</span>
						}
<span class="nc" id="L748">						break;</span>
					default:
<span class="nc" id="L750">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L751">						reader.skipValue();</span>
<span class="nc" id="L752">						continue;</span>
				}
			}
<span class="nc" id="L755">			reader.endObject();</span>
<span class="nc" id="L756">			Long newId = tokenRepository.saveAccessToken(token).getId();</span>
<span class="nc" id="L757">			maps.getAccessTokenToClientRefs().put(currentId, clientId);</span>
<span class="nc" id="L758">			maps.getAccessTokenToAuthHolderRefs().put(currentId, authHolderId);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">			if (refreshTokenId != null) {</span>
<span class="nc" id="L760">				maps.getAccessTokenToRefreshTokenRefs().put(currentId, refreshTokenId);</span>
			}
<span class="nc" id="L762">			maps.getAccessTokenOldToNewIdMap().put(currentId, newId);</span>
<span class="nc" id="L763">			logger.debug(&quot;Read access token {}&quot;, currentId);</span>
<span class="nc" id="L764">		}</span>
<span class="nc" id="L765">		reader.endArray();</span>
<span class="nc" id="L766">		logger.info(&quot;Done reading access tokens&quot;);</span>
<span class="nc" id="L767">	}</span>
	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readAuthenticationHolders(JsonReader reader) throws IOException {
<span class="nc" id="L773">		reader.beginArray();</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L775">			AuthenticationHolderEntity ahe = new AuthenticationHolderEntity();</span>
<span class="nc" id="L776">			reader.beginObject();</span>
<span class="nc" id="L777">			Long currentId = null;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L779" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L781">						continue;</span>
					case NAME:
<span class="nc" id="L783">						String name = reader.nextName();</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">						if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L785">							reader.skipValue();</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">						} else if (name.equals(ID)) {</span>
<span class="nc" id="L787">							currentId = reader.nextLong();</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">						} else if (name.equals(REQUEST_PARAMETERS)) {</span>
<span class="nc" id="L789">							ahe.setRequestParameters(readMap(reader));</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">						} else if (name.equals(CLIENT_ID)) {</span>
<span class="nc" id="L791">							ahe.setClientId(reader.nextString());</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">						} else if (name.equals(SCOPE)) {</span>
<span class="nc" id="L793">							ahe.setScope(readSet(reader));</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">						} else if (name.equals(RESOURCE_IDS)) {</span>
<span class="nc" id="L795">							ahe.setResourceIds(readSet(reader));</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">						} else if (name.equals(AUTHORITIES)) {</span>
<span class="nc" id="L797">							Set&lt;String&gt; authorityStrs = readSet(reader);</span>
<span class="nc" id="L798">							Set&lt;GrantedAuthority&gt; authorities = new HashSet&lt;GrantedAuthority&gt;();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">							for (String s : authorityStrs) {</span>
<span class="nc" id="L800">								GrantedAuthority ga = new SimpleGrantedAuthority(s);</span>
<span class="nc" id="L801">								authorities.add(ga);</span>
<span class="nc" id="L802">							}</span>
<span class="nc" id="L803">							ahe.setAuthorities(authorities);</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">						} else if (name.equals(APPROVED)) {</span>
<span class="nc" id="L805">							ahe.setApproved(reader.nextBoolean());</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">						} else if (name.equals(REDIRECT_URI)) {</span>
<span class="nc" id="L807">							ahe.setRedirectUri(reader.nextString());</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">						} else if (name.equals(RESPONSE_TYPES)) {</span>
<span class="nc" id="L809">							ahe.setResponseTypes(readSet(reader));</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">						} else if (name.equals(EXTENSIONS)) {</span>
<span class="nc" id="L811">							ahe.setExtensions(readMap(reader));</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">						} else if (name.equals(SAVED_USER_AUTHENTICATION)) {</span>
<span class="nc" id="L813">							ahe.setUserAuth(readSavedUserAuthentication(reader));</span>
						} else {
<span class="nc" id="L815">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L816">							reader.skipValue();</span>
						}
<span class="nc" id="L818">						break;</span>
					default:
<span class="nc" id="L820">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L821">						reader.skipValue();</span>
<span class="nc" id="L822">						continue;</span>
				}
			}
<span class="nc" id="L825">			reader.endObject();</span>
<span class="nc" id="L826">			Long newId = authHolderRepository.save(ahe).getId();</span>
<span class="nc" id="L827">			maps.getAuthHolderOldToNewIdMap().put(currentId, newId);</span>
<span class="nc" id="L828">			logger.debug(&quot;Read authentication holder {}&quot;, currentId);</span>
<span class="nc" id="L829">		}</span>
<span class="nc" id="L830">		reader.endArray();</span>
<span class="nc" id="L831">		logger.info(&quot;Done reading authentication holders&quot;);</span>
<span class="nc" id="L832">	}</span>

	/**
	 * @param reader
	 * @return
	 * @throws IOException
	 */
	private SavedUserAuthentication readSavedUserAuthentication(JsonReader reader) throws IOException {
<span class="nc" id="L840">		SavedUserAuthentication savedUserAuth = new SavedUserAuthentication();</span>
<span class="nc" id="L841">		reader.beginObject();</span>

<span class="nc bnc" id="L843" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc bnc" id="L844" title="All 3 branches missed.">			switch(reader.peek()) {</span>
				case END_OBJECT:
<span class="nc" id="L846">					continue;</span>
				case NAME:
<span class="nc" id="L848">					String name = reader.nextName();</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">					if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L850">						reader.skipValue();</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">					} else if (name.equals(NAME)) {</span>
<span class="nc" id="L852">						savedUserAuth.setName(reader.nextString());</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">					} else if (name.equals(SOURCE_CLASS)) {</span>
<span class="nc" id="L854">						savedUserAuth.setSourceClass(reader.nextString());</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">					} else if (name.equals(AUTHENTICATED)) {</span>
<span class="nc" id="L856">						savedUserAuth.setAuthenticated(reader.nextBoolean());</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">					} else if (name.equals(AUTHORITIES)) {</span>
<span class="nc" id="L858">						Set&lt;String&gt; authorityStrs = readSet(reader);</span>
<span class="nc" id="L859">						Set&lt;GrantedAuthority&gt; authorities = new HashSet&lt;GrantedAuthority&gt;();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">						for (String s : authorityStrs) {</span>
<span class="nc" id="L861">							GrantedAuthority ga = new SimpleGrantedAuthority(s);</span>
<span class="nc" id="L862">							authorities.add(ga);</span>
<span class="nc" id="L863">						}</span>
<span class="nc" id="L864">						savedUserAuth.setAuthorities(authorities);</span>
<span class="nc" id="L865">					} else {</span>
<span class="nc" id="L866">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L867">						reader.skipValue();</span>
					}
<span class="nc" id="L869">					break;</span>
				default:
<span class="nc" id="L871">					logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L872">					reader.skipValue();</span>
<span class="nc" id="L873">					continue;</span>
			}
		}

<span class="nc" id="L877">		reader.endObject();</span>
<span class="nc" id="L878">		return savedUserAuth;</span>
	}

	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readGrants(JsonReader reader) throws IOException {
<span class="nc" id="L886">		reader.beginArray();</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L888">			ApprovedSite site = new ApprovedSite();</span>
<span class="nc" id="L889">			Long currentId = null;</span>
<span class="nc" id="L890">			Set&lt;Long&gt; tokenIds = null;</span>
<span class="nc" id="L891">			reader.beginObject();</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L893" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L895">						continue;</span>
					case NAME:
<span class="nc" id="L897">						String name = reader.nextName();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">						if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L899">							reader.skipValue();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">						} else if (name.equals(ID)) {</span>
<span class="nc" id="L901">							currentId = reader.nextLong();</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">						} else if (name.equals(ACCESS_DATE)) {</span>
<span class="nc" id="L903">							Date date = utcToDate(reader.nextString());</span>
<span class="nc" id="L904">							site.setAccessDate(date);</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">						} else if (name.equals(CLIENT_ID)) {</span>
<span class="nc" id="L906">							site.setClientId(reader.nextString());</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">						} else if (name.equals(CREATION_DATE)) {</span>
<span class="nc" id="L908">							Date date = utcToDate(reader.nextString());</span>
<span class="nc" id="L909">							site.setCreationDate(date);</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">						} else if (name.equals(TIMEOUT_DATE)) {</span>
<span class="nc" id="L911">							Date date = utcToDate(reader.nextString());</span>
<span class="nc" id="L912">							site.setTimeoutDate(date);</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">						} else if (name.equals(USER_ID)) {</span>
<span class="nc" id="L914">							site.setUserId(reader.nextString());</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">						} else if (name.equals(ALLOWED_SCOPES)) {</span>
<span class="nc" id="L916">							Set&lt;String&gt; allowedScopes = readSet(reader);</span>
<span class="nc" id="L917">							site.setAllowedScopes(allowedScopes);</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">						} else if (name.equals(APPROVED_ACCESS_TOKENS)) {</span>
<span class="nc" id="L919">							tokenIds = readSet(reader);</span>
						} else {
<span class="nc" id="L921">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L922">							reader.skipValue();</span>
						}
<span class="nc" id="L924">						break;</span>
					default:
<span class="nc" id="L926">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L927">						reader.skipValue();</span>
<span class="nc" id="L928">						continue;</span>
				}
			}
<span class="nc" id="L931">			reader.endObject();</span>
<span class="nc" id="L932">			Long newId = approvedSiteRepository.save(site).getId();</span>
<span class="nc" id="L933">			maps.getGrantOldToNewIdMap().put(currentId, newId);</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">			if (tokenIds != null) {</span>
<span class="nc" id="L935">				maps.getGrantToAccessTokensRefs().put(currentId, tokenIds);</span>
			}
<span class="nc" id="L937">			logger.debug(&quot;Read grant {}&quot;, currentId);</span>
<span class="nc" id="L938">		}</span>
<span class="nc" id="L939">		reader.endArray();</span>
<span class="nc" id="L940">		logger.info(&quot;Done reading grants&quot;);</span>
<span class="nc" id="L941">	}</span>

	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readWhitelistedSites(JsonReader reader) throws IOException {
<span class="nc" id="L948">		reader.beginArray();</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L950">			WhitelistedSite wlSite = new WhitelistedSite();</span>
<span class="nc" id="L951">			Long currentId = null;</span>
<span class="nc" id="L952">			reader.beginObject();</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L954" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L956">						continue;</span>
					case NAME:
<span class="nc" id="L958">						String name = reader.nextName();</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">						if (name.equals(ID)) {</span>
<span class="nc" id="L960">							currentId = reader.nextLong();</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">						} else if (name.equals(CLIENT_ID)) {</span>
<span class="nc" id="L962">							wlSite.setClientId(reader.nextString());</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">						} else if (name.equals(CREATOR_USER_ID)) {</span>
<span class="nc" id="L964">							wlSite.setCreatorUserId(reader.nextString());</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">						} else if (name.equals(ALLOWED_SCOPES)) {</span>
<span class="nc" id="L966">							Set&lt;String&gt; allowedScopes = readSet(reader);</span>
<span class="nc" id="L967">							wlSite.setAllowedScopes(allowedScopes);</span>
<span class="nc" id="L968">						} else {</span>
<span class="nc" id="L969">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L970">							reader.skipValue();</span>
						}
<span class="nc" id="L972">						break;</span>
					default:
<span class="nc" id="L974">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L975">						reader.skipValue();</span>
<span class="nc" id="L976">						continue;</span>
				}
			}
<span class="nc" id="L979">			reader.endObject();</span>
<span class="nc" id="L980">			Long newId = wlSiteRepository.save(wlSite).getId();</span>
<span class="nc" id="L981">			maps.getWhitelistedSiteOldToNewIdMap().put(currentId, newId);</span>
<span class="nc" id="L982">		}</span>
<span class="nc" id="L983">		reader.endArray();</span>
<span class="nc" id="L984">		logger.info(&quot;Done reading whitelisted sites&quot;);</span>
<span class="nc" id="L985">	}</span>

	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readBlacklistedSites(JsonReader reader) throws IOException {
<span class="nc" id="L992">		reader.beginArray();</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L994">			BlacklistedSite blSite = new BlacklistedSite();</span>
<span class="nc" id="L995">			reader.beginObject();</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L997" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L999">						continue;</span>
					case NAME:
<span class="nc" id="L1001">						String name = reader.nextName();</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">						if (name.equals(ID)) {</span>
<span class="nc" id="L1003">							reader.skipValue();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">						} else if (name.equals(URI)) {</span>
<span class="nc" id="L1005">							blSite.setUri(reader.nextString());</span>
						} else {
<span class="nc" id="L1007">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L1008">							reader.skipValue();</span>
						}
<span class="nc" id="L1010">						break;</span>
					default:
<span class="nc" id="L1012">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L1013">						reader.skipValue();</span>
<span class="nc" id="L1014">						continue;</span>
				}
			}
<span class="nc" id="L1017">			reader.endObject();</span>
<span class="nc" id="L1018">			blSiteRepository.save(blSite);</span>
<span class="nc" id="L1019">		}</span>
<span class="nc" id="L1020">		reader.endArray();</span>
<span class="nc" id="L1021">		logger.info(&quot;Done reading blacklisted sites&quot;);</span>
<span class="nc" id="L1022">	}</span>

	/**
	 * @param reader
	 * @throws IOException
	 */
	private void readClients(JsonReader reader) throws IOException {
<span class="nc" id="L1029">		reader.beginArray();</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L1031">			ClientDetailsEntity client = new ClientDetailsEntity();</span>
<span class="nc" id="L1032">			reader.beginObject();</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L1034" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L1036">						continue;</span>
					case NAME:
<span class="nc" id="L1038">						String name = reader.nextName();</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">						if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L1040">							reader.skipValue();</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">						} else if (name.equals(CLIENT_ID)) {</span>
<span class="nc" id="L1042">							client.setClientId(reader.nextString());</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">						} else if (name.equals(RESOURCE_IDS)) {</span>
<span class="nc" id="L1044">							Set&lt;String&gt; resourceIds = readSet(reader);</span>
<span class="nc" id="L1045">							client.setResourceIds(resourceIds);</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">						} else if (name.equals(SECRET)) {</span>
<span class="nc" id="L1047">							client.setClientSecret(reader.nextString());</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">						} else if (name.equals(SCOPE)) {</span>
<span class="nc" id="L1049">							Set&lt;String&gt; scope = readSet(reader);</span>
<span class="nc" id="L1050">							client.setScope(scope);</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">						} else if (name.equals(AUTHORITIES)) {</span>
<span class="nc" id="L1052">							Set&lt;String&gt; authorityStrs = readSet(reader);</span>
<span class="nc" id="L1053">							Set&lt;GrantedAuthority&gt; authorities = new HashSet&lt;GrantedAuthority&gt;();</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">							for (String s : authorityStrs) {</span>
<span class="nc" id="L1055">								GrantedAuthority ga = new SimpleGrantedAuthority(s);</span>
<span class="nc" id="L1056">								authorities.add(ga);</span>
<span class="nc" id="L1057">							}</span>
<span class="nc" id="L1058">							client.setAuthorities(authorities);</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">						} else if (name.equals(ACCESS_TOKEN_VALIDITY_SECONDS)) {</span>
<span class="nc" id="L1060">							client.setAccessTokenValiditySeconds(reader.nextInt());</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">						} else if (name.equals(REFRESH_TOKEN_VALIDITY_SECONDS)) {</span>
<span class="nc" id="L1062">							client.setRefreshTokenValiditySeconds(reader.nextInt());</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">						} else if (name.equals(ID_TOKEN_VALIDITY_SECONDS)) {</span>
<span class="nc" id="L1064">							client.setIdTokenValiditySeconds(reader.nextInt());</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">						} else if (name.equals(DEVICE_CODE_VALIDITY_SECONDS)) {</span>
<span class="nc" id="L1066">							client.setDeviceCodeValiditySeconds(reader.nextInt());</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">						} else if (name.equals(REDIRECT_URIS)) {</span>
<span class="nc" id="L1068">							Set&lt;String&gt; redirectUris = readSet(reader);</span>
<span class="nc" id="L1069">							client.setRedirectUris(redirectUris);</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">						} else if (name.equals(CLAIMS_REDIRECT_URIS)) {</span>
<span class="nc" id="L1071">							Set&lt;String&gt; claimsRedirectUris = readSet(reader);</span>
<span class="nc" id="L1072">							client.setClaimsRedirectUris(claimsRedirectUris);</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">						} else if (name.equals(NAME)) {</span>
<span class="nc" id="L1074">							client.setClientName(reader.nextString());</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">						} else if (name.equals(URI)) {</span>
<span class="nc" id="L1076">							client.setClientUri(reader.nextString());</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">						} else if (name.equals(LOGO_URI)) {</span>
<span class="nc" id="L1078">							client.setLogoUri(reader.nextString());</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">						} else if (name.equals(CONTACTS)) {</span>
<span class="nc" id="L1080">							Set&lt;String&gt; contacts = readSet(reader);</span>
<span class="nc" id="L1081">							client.setContacts(contacts);</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">						} else if (name.equals(TOS_URI)) {</span>
<span class="nc" id="L1083">							client.setTosUri(reader.nextString());</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">						} else if (name.equals(TOKEN_ENDPOINT_AUTH_METHOD)) {</span>
<span class="nc" id="L1085">							AuthMethod am = AuthMethod.getByValue(reader.nextString());</span>
<span class="nc" id="L1086">							client.setTokenEndpointAuthMethod(am);</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">						} else if (name.equals(GRANT_TYPES)) {</span>
<span class="nc" id="L1088">							Set&lt;String&gt; grantTypes = readSet(reader);</span>
<span class="nc" id="L1089">							client.setGrantTypes(grantTypes);</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">						} else if (name.equals(RESPONSE_TYPES)) {</span>
<span class="nc" id="L1091">							Set&lt;String&gt; responseTypes = readSet(reader);</span>
<span class="nc" id="L1092">							client.setResponseTypes(responseTypes);</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">						} else if (name.equals(POLICY_URI)) {</span>
<span class="nc" id="L1094">							client.setPolicyUri(reader.nextString());</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">						} else if (name.equals(APPLICATION_TYPE)) {</span>
<span class="nc" id="L1096">							AppType appType = AppType.getByValue(reader.nextString());</span>
<span class="nc" id="L1097">							client.setApplicationType(appType);</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">						} else if (name.equals(SECTOR_IDENTIFIER_URI)) {</span>
<span class="nc" id="L1099">							client.setSectorIdentifierUri(reader.nextString());</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">						} else if (name.equals(SUBJECT_TYPE)) {</span>
<span class="nc" id="L1101">							SubjectType st = SubjectType.getByValue(reader.nextString());</span>
<span class="nc" id="L1102">							client.setSubjectType(st);</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">						} else if (name.equals(JWKS_URI)) {</span>
<span class="nc" id="L1104">							client.setJwksUri(reader.nextString());</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">						} else if (name.equals(JWKS)) {</span>
							try {
<span class="nc" id="L1107">								client.setJwks(JWKSet.parse(reader.nextString()));</span>
<span class="nc" id="L1108">							} catch (ParseException e) {</span>
<span class="nc" id="L1109">								logger.error(&quot;Couldn't parse JWK Set&quot;, e);</span>
<span class="nc" id="L1110">							}</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">						} else if (name.equals(REQUEST_OBJECT_SIGNING_ALG)) {</span>
<span class="nc" id="L1112">							JWSAlgorithm alg = JWSAlgorithm.parse(reader.nextString());</span>
<span class="nc" id="L1113">							client.setRequestObjectSigningAlg(alg);</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">						} else if (name.equals(USER_INFO_ENCRYPTED_RESPONSE_ALG)) {</span>
<span class="nc" id="L1115">							JWEAlgorithm alg = JWEAlgorithm.parse(reader.nextString());</span>
<span class="nc" id="L1116">							client.setUserInfoEncryptedResponseAlg(alg);</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">						} else if (name.equals(USER_INFO_ENCRYPTED_RESPONSE_ENC)) {</span>
<span class="nc" id="L1118">							EncryptionMethod alg = EncryptionMethod.parse(reader.nextString());</span>
<span class="nc" id="L1119">							client.setUserInfoEncryptedResponseEnc(alg);</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">						} else if (name.equals(USER_INFO_SIGNED_RESPONSE_ALG)) {</span>
<span class="nc" id="L1121">							JWSAlgorithm alg = JWSAlgorithm.parse(reader.nextString());</span>
<span class="nc" id="L1122">							client.setUserInfoSignedResponseAlg(alg);</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">						} else if (name.equals(ID_TOKEN_SIGNED_RESPONSE_ALG)) {</span>
<span class="nc" id="L1124">							JWSAlgorithm alg = JWSAlgorithm.parse(reader.nextString());</span>
<span class="nc" id="L1125">							client.setIdTokenSignedResponseAlg(alg);</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">						} else if (name.equals(ID_TOKEN_ENCRYPTED_RESPONSE_ALG)) {</span>
<span class="nc" id="L1127">							JWEAlgorithm alg = JWEAlgorithm.parse(reader.nextString());</span>
<span class="nc" id="L1128">							client.setIdTokenEncryptedResponseAlg(alg);</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">						} else if (name.equals(ID_TOKEN_ENCRYPTED_RESPONSE_ENC)) {</span>
<span class="nc" id="L1130">							EncryptionMethod alg = EncryptionMethod.parse(reader.nextString());</span>
<span class="nc" id="L1131">							client.setIdTokenEncryptedResponseEnc(alg);</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">						} else if (name.equals(TOKEN_ENDPOINT_AUTH_SIGNING_ALG)) {</span>
<span class="nc" id="L1133">							JWSAlgorithm alg = JWSAlgorithm.parse(reader.nextString());</span>
<span class="nc" id="L1134">							client.setTokenEndpointAuthSigningAlg(alg);</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">						} else if (name.equals(DEFAULT_MAX_AGE)) {</span>
<span class="nc" id="L1136">							client.setDefaultMaxAge(reader.nextInt());</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">						} else if (name.equals(REQUIRE_AUTH_TIME)) {</span>
<span class="nc" id="L1138">							client.setRequireAuthTime(reader.nextBoolean());</span>
<span class="nc bnc" id="L1139" title="All 2 branches missed.">						} else if (name.equals(DEFAULT_ACR_VALUES)) {</span>
<span class="nc" id="L1140">							Set&lt;String&gt; defaultACRvalues = readSet(reader);</span>
<span class="nc" id="L1141">							client.setDefaultACRvalues(defaultACRvalues);</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">						} else if (name.equals(&quot;initiateLoginUri&quot;)) {</span>
<span class="nc" id="L1143">							client.setInitiateLoginUri(reader.nextString());</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">						} else if (name.equals(POST_LOGOUT_REDIRECT_URI)) {</span>
<span class="nc" id="L1145">							Set&lt;String&gt; postLogoutUris = readSet(reader);</span>
<span class="nc" id="L1146">							client.setPostLogoutRedirectUris(postLogoutUris);</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">						} else if (name.equals(REQUEST_URIS)) {</span>
<span class="nc" id="L1148">							Set&lt;String&gt; requestUris = readSet(reader);</span>
<span class="nc" id="L1149">							client.setRequestUris(requestUris);</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">						} else if (name.equals(DESCRIPTION)) {</span>
<span class="nc" id="L1151">							client.setClientDescription(reader.nextString());</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">						} else if (name.equals(ALLOW_INTROSPECTION)) {</span>
<span class="nc" id="L1153">							client.setAllowIntrospection(reader.nextBoolean());</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">						} else if (name.equals(REUSE_REFRESH_TOKEN)) {</span>
<span class="nc" id="L1155">							client.setReuseRefreshToken(reader.nextBoolean());</span>
<span class="nc bnc" id="L1156" title="All 2 branches missed.">						} else if (name.equals(CLEAR_ACCESS_TOKENS_ON_REFRESH)) {</span>
<span class="nc" id="L1157">							client.setClearAccessTokensOnRefresh(reader.nextBoolean());</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">						} else if (name.equals(DYNAMICALLY_REGISTERED)) {</span>
<span class="nc" id="L1159">							client.setDynamicallyRegistered(reader.nextBoolean());</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">						} else if (name.equals(CODE_CHALLENGE_METHOD)) {</span>
<span class="nc" id="L1161">							client.setCodeChallengeMethod(PKCEAlgorithm.parse(reader.nextString()));</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">						} else if (name.equals(SOFTWARE_ID)) {</span>
<span class="nc" id="L1163">							client.setSoftwareId(reader.nextString());</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">						} else if (name.equals(SOFTWARE_VERSION)) {</span>
<span class="nc" id="L1165">							client.setSoftwareVersion(reader.nextString());</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">						} else if (name.equals(SOFTWARE_STATEMENT)) {</span>
							try {
<span class="nc" id="L1168">								client.setSoftwareStatement(JWTParser.parse(reader.nextString()));</span>
<span class="nc" id="L1169">							} catch (ParseException e) {</span>
<span class="nc" id="L1170">								logger.error(&quot;Couldn't parse software statement&quot;, e);</span>
<span class="nc" id="L1171">							}</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">						} else if (name.equals(CREATION_DATE)) {</span>
<span class="nc" id="L1173">							Date date = utcToDate(reader.nextString());</span>
<span class="nc" id="L1174">							client.setCreatedAt(date);</span>
<span class="nc" id="L1175">						} else {</span>
<span class="nc" id="L1176">							logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L1177">							reader.skipValue();</span>
						}
<span class="nc" id="L1179">						break;</span>
					default:
<span class="nc" id="L1181">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L1182">						reader.skipValue();</span>
<span class="nc" id="L1183">						continue;</span>
				}
			}
<span class="nc" id="L1186">			reader.endObject();</span>
<span class="nc" id="L1187">			clientRepository.saveClient(client);</span>
<span class="nc" id="L1188">		}</span>
<span class="nc" id="L1189">		reader.endArray();</span>
<span class="nc" id="L1190">		logger.info(&quot;Done reading clients&quot;);</span>
<span class="nc" id="L1191">	}</span>

	/**
	 * Read the list of system scopes from the reader and insert them into the
	 * scope repository.
	 *
	 * @param reader
	 * @throws IOException
	 */
	private void readSystemScopes(JsonReader reader) throws IOException {
<span class="nc" id="L1201">		reader.beginArray();</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">		while (reader.hasNext()) {</span>
<span class="nc" id="L1203">			SystemScope scope = new SystemScope();</span>
<span class="nc" id="L1204">			reader.beginObject();</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">			while (reader.hasNext()) {</span>
<span class="nc bnc" id="L1206" title="All 3 branches missed.">				switch (reader.peek()) {</span>
					case END_OBJECT:
<span class="nc" id="L1208">						continue;</span>
					case NAME:
<span class="nc" id="L1210">						String name = reader.nextName();</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">						if (reader.peek() == JsonToken.NULL) {</span>
<span class="nc" id="L1212">							reader.skipValue();</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">						} else if (name.equals(VALUE)) {</span>
<span class="nc" id="L1214">							scope.setValue(reader.nextString());</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">						} else if (name.equals(DESCRIPTION)) {</span>
<span class="nc" id="L1216">							scope.setDescription(reader.nextString());</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">						} else if (name.equals(RESTRICTED)) {</span>
<span class="nc" id="L1218">							scope.setRestricted(reader.nextBoolean());</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">						} else if (name.equals(DEFAULT_SCOPE)) {</span>
<span class="nc" id="L1220">							scope.setDefaultScope(reader.nextBoolean());</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">						} else if (name.equals(ICON)) {</span>
<span class="nc" id="L1222">							scope.setIcon(reader.nextString());</span>
						} else {
<span class="nc" id="L1224">							logger.debug(&quot;found unexpected entry&quot;);</span>
<span class="nc" id="L1225">							reader.skipValue();</span>
						}
<span class="nc" id="L1227">						break;</span>
					default:
<span class="nc" id="L1229">						logger.debug(&quot;Found unexpected entry&quot;);</span>
<span class="nc" id="L1230">						reader.skipValue();</span>
<span class="nc" id="L1231">						continue;</span>
				}
			}
<span class="nc" id="L1234">			reader.endObject();</span>
<span class="nc" id="L1235">			sysScopeRepository.save(scope);</span>
<span class="nc" id="L1236">		}</span>
<span class="nc" id="L1237">		reader.endArray();</span>
<span class="nc" id="L1238">		logger.info(&quot;Done reading system scopes&quot;);</span>
<span class="nc" id="L1239">	}</span>

	private void fixObjectReferences() {
<span class="nc" id="L1242">		logger.info(&quot;Fixing object references...&quot;);</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">		for (Long oldRefreshTokenId : maps.getRefreshTokenToClientRefs().keySet()) {</span>
<span class="nc" id="L1244">			String clientRef = maps.getRefreshTokenToClientRefs().get(oldRefreshTokenId);</span>
<span class="nc" id="L1245">			ClientDetailsEntity client = clientRepository.getClientByClientId(clientRef);</span>
<span class="nc" id="L1246">			Long newRefreshTokenId = maps.getRefreshTokenOldToNewIdMap().get(oldRefreshTokenId);</span>
<span class="nc" id="L1247">			OAuth2RefreshTokenEntity refreshToken = tokenRepository.getRefreshTokenById(newRefreshTokenId);</span>
<span class="nc" id="L1248">			refreshToken.setClient(client);</span>
<span class="nc" id="L1249">			tokenRepository.saveRefreshToken(refreshToken);</span>
<span class="nc" id="L1250">		}</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">		for (Long oldRefreshTokenId : maps.getRefreshTokenToAuthHolderRefs().keySet()) {</span>
<span class="nc" id="L1252">			Long oldAuthHolderId = maps.getRefreshTokenToAuthHolderRefs().get(oldRefreshTokenId);</span>
<span class="nc" id="L1253">			Long newAuthHolderId = maps.getAuthHolderOldToNewIdMap().get(oldAuthHolderId);</span>
<span class="nc" id="L1254">			AuthenticationHolderEntity authHolder = authHolderRepository.getById(newAuthHolderId);</span>
<span class="nc" id="L1255">			Long newRefreshTokenId = maps.getRefreshTokenOldToNewIdMap().get(oldRefreshTokenId);</span>
<span class="nc" id="L1256">			OAuth2RefreshTokenEntity refreshToken = tokenRepository.getRefreshTokenById(newRefreshTokenId);</span>
<span class="nc" id="L1257">			refreshToken.setAuthenticationHolder(authHolder);</span>
<span class="nc" id="L1258">			tokenRepository.saveRefreshToken(refreshToken);</span>
<span class="nc" id="L1259">		}</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">		for (Long oldAccessTokenId : maps.getAccessTokenToClientRefs().keySet()) {</span>
<span class="nc" id="L1261">			String clientRef = maps.getAccessTokenToClientRefs().get(oldAccessTokenId);</span>
<span class="nc" id="L1262">			ClientDetailsEntity client = clientRepository.getClientByClientId(clientRef);</span>
<span class="nc" id="L1263">			Long newAccessTokenId = maps.getAccessTokenOldToNewIdMap().get(oldAccessTokenId);</span>
<span class="nc" id="L1264">			OAuth2AccessTokenEntity accessToken = tokenRepository.getAccessTokenById(newAccessTokenId);</span>
<span class="nc" id="L1265">			accessToken.setClient(client);</span>
<span class="nc" id="L1266">			tokenRepository.saveAccessToken(accessToken);</span>
<span class="nc" id="L1267">		}</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">		for (Long oldAccessTokenId : maps.getAccessTokenToAuthHolderRefs().keySet()) {</span>
<span class="nc" id="L1269">			Long oldAuthHolderId = maps.getAccessTokenToAuthHolderRefs().get(oldAccessTokenId);</span>
<span class="nc" id="L1270">			Long newAuthHolderId = maps.getAuthHolderOldToNewIdMap().get(oldAuthHolderId);</span>
<span class="nc" id="L1271">			AuthenticationHolderEntity authHolder = authHolderRepository.getById(newAuthHolderId);</span>
<span class="nc" id="L1272">			Long newAccessTokenId = maps.getAccessTokenOldToNewIdMap().get(oldAccessTokenId);</span>
<span class="nc" id="L1273">			OAuth2AccessTokenEntity accessToken = tokenRepository.getAccessTokenById(newAccessTokenId);</span>
<span class="nc" id="L1274">			accessToken.setAuthenticationHolder(authHolder);</span>
<span class="nc" id="L1275">			tokenRepository.saveAccessToken(accessToken);</span>
<span class="nc" id="L1276">		}</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">		for (Long oldAccessTokenId : maps.getAccessTokenToRefreshTokenRefs().keySet()) {</span>
<span class="nc" id="L1278">			Long oldRefreshTokenId = maps.getAccessTokenToRefreshTokenRefs().get(oldAccessTokenId);</span>
<span class="nc" id="L1279">			Long newRefreshTokenId = maps.getRefreshTokenOldToNewIdMap().get(oldRefreshTokenId);</span>
<span class="nc" id="L1280">			OAuth2RefreshTokenEntity refreshToken = tokenRepository.getRefreshTokenById(newRefreshTokenId);</span>
<span class="nc" id="L1281">			Long newAccessTokenId = maps.getAccessTokenOldToNewIdMap().get(oldAccessTokenId);</span>
<span class="nc" id="L1282">			OAuth2AccessTokenEntity accessToken = tokenRepository.getAccessTokenById(newAccessTokenId);</span>
<span class="nc" id="L1283">			accessToken.setRefreshToken(refreshToken);</span>
<span class="nc" id="L1284">			tokenRepository.saveAccessToken(accessToken);</span>
<span class="nc" id="L1285">		}</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">		for (Long oldGrantId : maps.getGrantToAccessTokensRefs().keySet()) {</span>
<span class="nc" id="L1287">			Set&lt;Long&gt; oldAccessTokenIds = maps.getGrantToAccessTokensRefs().get(oldGrantId);</span>

<span class="nc" id="L1289">			Long newGrantId = maps.getGrantOldToNewIdMap().get(oldGrantId);</span>
<span class="nc" id="L1290">			ApprovedSite site = approvedSiteRepository.getById(newGrantId);</span>

<span class="nc bnc" id="L1292" title="All 2 branches missed.">			for(Long oldTokenId : oldAccessTokenIds) {</span>
<span class="nc" id="L1293">				Long newTokenId = maps.getAccessTokenOldToNewIdMap().get(oldTokenId);</span>
<span class="nc" id="L1294">				OAuth2AccessTokenEntity token = tokenRepository.getAccessTokenById(newTokenId);</span>
<span class="nc" id="L1295">				token.setApprovedSite(site);</span>
<span class="nc" id="L1296">				tokenRepository.saveAccessToken(token);</span>
<span class="nc" id="L1297">			}</span>

<span class="nc" id="L1299">			approvedSiteRepository.save(site);</span>
<span class="nc" id="L1300">		}</span>
		/*
		refreshTokenToClientRefs.clear();
		refreshTokenToAuthHolderRefs.clear();
		accessTokenToClientRefs.clear();
		accessTokenToAuthHolderRefs.clear();
		accessTokenToRefreshTokenRefs.clear();
		refreshTokenOldToNewIdMap.clear();
		accessTokenOldToNewIdMap.clear();
		grantOldToNewIdMap.clear();
		 */
<span class="nc" id="L1311">		logger.info(&quot;Done fixing object references.&quot;);</span>
<span class="nc" id="L1312">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>